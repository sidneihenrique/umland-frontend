<div class="admin-panel">
  <h1>Painel do Administrador</h1>

  <div class="tabs-navigation">
    <button *ngFor="let tab of tabs" class="tab-button" [class.active]="activeTab === tab.id"
      (click)="setActiveTab(tab.id)">
      {{ tab.name }}
    </button>
  </div>

  <div *ngIf="activeTab === 'avatars'" class="card">
    <div class="card-header">
      <h2>Cadastro de Avatar</h2>
    </div>
    <div class="card-content">
      <form (ngSubmit)="onSubmitAvatar()" #avatarForm="ngForm" class="form">
        <div class="file-input-container">
          <label class="file-label">
            <input type="file" name="avatarImage" accept="image/*" (change)="onAvatarImageChange($event)" />
            <span class="file-button">Escolher Imagem</span>
          </label>
          <div *ngIf="avatarPreview" class="image-preview">
            <img [src]="avatarPreview" alt="Preview" />
          </div>
        </div>
        <button type="submit" class="btn-primary" [disabled]="!avatarImageFile && !editAvatarId">
          {{ editAvatarId ? 'Atualizar Avatar' : 'Salvar Avatar' }}
        </button>
        <button type="button" (click)="resetAvatarForm()" class="btn-secondary">Limpar</button>
      </form>

      <div class="items-grid">
        <div *ngFor="let a of avatars; let i = index" class="item-card">
          <div class="item-image">
            <img [src]="getAvatarImageUrl(a.filePath || '')" alt="Avatar" />
          </div>
          <div class="item-actions">
            <button class="btn-edit" (click)="editAvatar(i)">Editar</button>
            <button class="btn-delete" (click)="deleteAvatar(i)">Remover</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="activeTab === 'characters'" class="card">
    <div class="card-header">
      <h2>Cadastro de Personagem</h2>
    </div>
    <div class="card-content">
      <form (ngSubmit)="onSubmitCharacter()" #characterForm="ngForm" class="form">
        <div class="form-group">
          <label>Nome do Personagem:</label>
          <input type="text" name="name" [(ngModel)]="character.name" required class="form-input" />
        </div>
        <div class="file-input-container">
          <label class="file-label">
            <input type="file" name="characterImage" accept="image/*" (change)="onCharacterImageChange($event)" />
            <span class="file-button">Escolher Imagem</span>
          </label>
          <div *ngIf="characterPreview" class="image-preview">
            <img [src]="characterPreview" alt="Preview" />
          </div>
        </div>
        <button type="submit" class="btn-primary"
          [disabled]="!character.name || (!characterImageFile && !editCharacterId)">
          {{ editCharacterId ? 'Atualizar Personagem' : 'Salvar Personagem' }}
        </button>
        <button type="button" (click)="resetCharacterForm()" class="btn-secondary">Limpar</button>
      </form>

      <div class="items-grid">
        <div *ngFor="let c of characters; let i = index" class="item-card">
          <div class="item-image">
            <img [src]="getCharacterImageUrl(c.filePath)" [alt]="c.name" />
          </div>
          <div class="item-info">
            <h4>{{ c.name }}</h4>
          </div>
          <div class="item-actions">
            <button class="btn-edit" (click)="editCharacter(i)">Editar</button>
            <button class="btn-delete" (click)="deleteCharacter(i)">Remover</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="activeTab === 'phases'" class="card">
    <div class="card-header">
      <h2>Cadastro de Fase</h2>
    </div>
    <div class="card-content">
      <form (ngSubmit)="onSubmitPhase()" #phaseForm="ngForm" class="form">
        <div class="form-group">
          <label>T√≠tulo da Fase:</label>
          <input type="text" name="title" [(ngModel)]="phase.title" required class="form-input" />
        </div>

        <div class="form-group">
          <label>Descri√ß√£o:</label>
          <textarea name="description" [(ngModel)]="phase.description" class="form-textarea" rows="3"></textarea>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Tipo da Fase:</label>
            <select name="type" [(ngModel)]="phase.type" required class="form-select">
              <option value="BUILD">üî® BUILD</option>
              <option value="FIX">üîß FIX</option>
              <option value="COMPLETE">‚úÖ COMPLETE</option>
            </select>
          </div>
          <div class="form-group">
            <label>Modo:</label>
            <select name="mode" [(ngModel)]="phase.mode" required class="form-select">
              <option value="BASIC">üü¢ B√ÅSICO</option>
              <option value="INTERMEDIATE">üü° INTERMEDI√ÅRIO</option>
              <option value="ADVANCED">üî¥ AVAN√áADO</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label>Tempo M√°ximo (segundos):</label>
          <input type="number" name="maxTime" [(ngModel)]="phase.maxTime" required class="form-input" min="60" />
        </div>

        <div class="form-group">
          <label>Personagem:</label>
          <select name="characterId" [(ngModel)]="selectedCharacterId" required class="form-select">
            <option value="0">Selecione um personagem</option>
            <option *ngFor="let char of characters" [value]="char.id">
              PERSONAGENS {{ char.name }}
            </option>
          </select>
        </div>

        <div class="form-group">
          <label>GameMap:</label>
          <select name="gameMapId" [(ngModel)]="selectedGameMapId" required class="form-select">
            <option value="0">Selecione um GameMap</option>
            <option *ngFor="let gameMap of gameMaps" [value]="gameMap.id">
              MAPAS {{ gameMap.title }}
            </option>
          </select>
        </div>

        <div class="form-group">
          <label>Falas do Personagem:</label>
          <div class="dialogue-input-container">
            <div class="dialogue-input-row">
              <textarea [(ngModel)]="newDialogue" name="newDialogue" placeholder="Digite uma fala do personagem..."
                class="form-textarea dialogue-input" rows="2"></textarea>
              <div class="dialogue-buttons">
                <button type="button" (click)="addDialogue()" class="btn-dialogue add" [disabled]="!newDialogue.trim()">
                  {{ editingDialogueIndex >= 0 ? 'Editar' : 'Adicionar' }}
                </button>
                <button type="button" (click)="cancelEditDialogue()" class="btn-dialogue cancel"
                  *ngIf="editingDialogueIndex >= 0">
                  Remover
                </button>
              </div>
            </div>
          </div>

          <div class="dialogues-list" *ngIf="phase.characterDialogues.length > 0">
            <div *ngFor="let dialogue of phase.characterDialogues; let i = index" class="dialogue-item"
              [class.editing]="editingDialogueIndex === i">

              <div class="dialogue-number">{{ i + 1 }}</div>

              <div class="dialogue-content">
                <p>{{ dialogue }}</p>
              </div>

              <div class="dialogue-actions">
                <button type="button" (click)="moveDialogueUp(i)" class="btn-dialogue move" [disabled]="i === 0"
                  title="Mover para cima">
                  ‚¨ÜÔ∏è
                </button>

                <button type="button" (click)="moveDialogueDown(i)" class="btn-dialogue move"
                  [disabled]="i === phase.characterDialogues.length - 1" title="Mover para baixo">
                  ‚¨áÔ∏è
                </button>

                <button type="button" (click)="editDialogue(i)" class="btn-dialogue edit" title="Editar fala">
                  Editar
                </button>

                <button type="button" (click)="removeDialogue(i)" class="btn-dialogue remove" title="Remover fala">
                  Remover
                </button>
              </div>
            </div>
          </div>

          <div class="dialogues-counter" *ngIf="phase.characterDialogues.length > 0">
            <small>{{ phase.characterDialogues.length }} fala(s) adicionada(s)</small>
          </div>
        </div>

        <div class="form-group">
          <label>Diagrama Inicial:</label>

          <div class="diagram-editor-section">
            <div class="diagram-controls">
              <button type="button" (click)="saveDiagramToPhase()" class="btn-diagram save">
                Salvar Diagrama Inicial
              </button>

              <button type="button" (click)="clearDiagram()" class="btn-diagram clear">
                Limpar Diagrama Inicial
              </button>
            </div>

            <diagram-editor #diagramEditorInitial></diagram-editor>
          </div>
        </div>

        <div class="form-group">
          <label>Diagramas Corretos:</label>
          <div class="diagram-editor-section">
            <div class="diagram-controls">
              <button type="button" (click)="saveCorrectDiagram()" class="btn-diagram save">
                {{ editingCorrectDiagramIndex >= 0 ? 'Atualizar Diagrama' : 'Adicionar como Correto' }}
              </button>

              <button type="button" (click)="cancelEditCorrectDiagram()" class="btn-diagram cancel"
                *ngIf="editingCorrectDiagramIndex >= 0">
                Cancelar Edi√ß√£o
              </button>

              <button type="button" (click)="clearCorrectDiagram()" class="btn-diagram clear">
                Limpar Editor
              </button>
            </div>

            <div class="editing-indicator" *ngIf="editingCorrectDiagramIndex >= 0">
              <span class="indicator-text">
                Editando diagrama correto #{{ editingCorrectDiagramIndex + 1 }}
              </span>
            </div>

            <diagram-editor #diagramEditorCorrect></diagram-editor>
          </div>

          <div class="correct-diagrams-list" *ngIf="phase.correctDiagrams.length > 0">
            <h4>Diagramas Corretos Cadastrados:</h4>

            <div *ngFor="let diagram of phase.correctDiagrams; let i = index" class="correct-diagram-item"
              [class.editing]="editingCorrectDiagramIndex === i">

              <div class="diagram-number">{{ i + 1 }}</div>

              <div class="diagram-info">
                <div class="diagram-preview">
                  {{ getCorrectDiagramPreview(diagram) }}
                </div>
              </div>

              <div class="diagram-actions">
                <button type="button" (click)="moveCorrectDiagramUp(i)" class="btn-diagram-action move"
                  [disabled]="i === 0" title="Mover para cima">
                  ‚¨ÜÔ∏è
                </button>

                <button type="button" (click)="moveCorrectDiagramDown(i)" class="btn-diagram-action move"
                  [disabled]="i === phase.correctDiagrams.length - 1" title="Mover para baixo">
                  ‚¨áÔ∏è
                </button>

                <button type="button" (click)="editCorrectDiagram(i)" class="btn-diagram-action edit"
                  title="Editar diagrama">
                  Editar
                </button>

                <button type="button" (click)="removeCorrectDiagram(i)" class="btn-diagram-action remove"
                  title="Remover diagrama">
                  Remover
                </button>
              </div>
            </div>
          </div>

          <div class="correct-diagrams-counter" *ngIf="phase.correctDiagrams.length > 0">
            <small>{{ phase.correctDiagrams.length }} diagrama(s) correto(s) cadastrado(s)</small>
          </div>
        </div>

        <button type="submit" class="btn-primary"
          [disabled]="!phase.title || !selectedCharacterId || !selectedGameMapId">
          {{ editPhaseId ? 'Atualizar Fase' : 'Salvar Fase' }}
        </button>
        <button type="button" (click)="resetPhaseForm()" class="btn-secondary">Limpar</button>
      </form>

      <div class="phases-list">
        <div *ngFor="let phase of phases; let i = index" class="phase-card expanded">
          <div class="phase-header">
            <div class="phase-badges">
              <span class="badge type-{{ phase.type.toLowerCase() }}">{{ phase.type }}</span>
              <span class="badge mode-{{ (phase.mode || 'basic').toLowerCase() }}">{{ phase.mode || 'BASIC' }}</span>
            </div>
            <h3>{{ phase.title }}</h3>
          </div>

          <div class="phase-details">
            <div class="detail-grid">
              <div class="detail-item">
                <span class="detail-label">Tempo:</span>
                <span class="detail-value">{{ formatTime(phase.maxTime) }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Personagem:</span>
                <span class="detail-value">{{ phase?.character?.name || 'N/A' }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">GameMap:</span>
                <span class="detail-value">{{ phase?.gameMap?.title || 'N/A' }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Diagrama:</span>
                <span class="detail-value">{{ phase?.diagramInitial ? 'Definido' : 'Vazio' }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Corretos:</span>
                <span class="detail-value">{{ phase?.correctDiagrams?.length || 0 }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Di√°logos:</span>
                <span class="detail-value">{{ phase?.characterDialogues?.length || 0 }}</span>
              </div>
            </div>
            <div *ngIf="phase.description" class="phase-description">
              <p>{{ phase.description }}</p>
            </div>
          </div>

          <div class="item-actions">
            <button class="btn-edit" (click)="editPhase(i)">Editar</button>
            <button class="btn-delete" (click)="deletePhase(i)">Remover</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="activeTab === 'tips'" class="card">
    <div class="card-header">
      <h2>Cadastro de Dicas</h2>
    </div>
    <div class="card-content">
      <form (ngSubmit)="onSubmitTip()" #tipForm="ngForm" class="form">
        <div class="form-group">
          <label>Dica:</label>
          <textarea name="tip" [(ngModel)]="tip.tip" required class="form-textarea"
            placeholder="Digite aqui a dica para os jogadores..."></textarea>
        </div>
        <button type="submit" class="btn-primary" [disabled]="!tip.tip || !tip.tip.trim()">
          {{ editTipId ? 'Atualizar Dica' : 'Salvar Dica' }}
        </button>
        <button type="button" (click)="resetTipForm()" class="btn-secondary">Limpar</button>
      </form>

      <div class="tips-list">
        <div *ngFor="let t of tips; let i = index" class="tip-card">
          <div class="tip-icon">Dicas</div>
          <div class="tip-content">
            <p>{{ t.tip }}</p>
            <small class="tip-id">ID: {{ t.id }}</small>
          </div>
          <div class="item-actions">
            <button class="btn-edit" (click)="editTip(i)">Editar</button>
            <button class="btn-delete" (click)="deleteTip(i)">Remover</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="activeTab === 'gamemaps'" class="card">
    <div class="card-header">
      <h2>Cadastro de GameMap</h2>
    </div>
    <div class="card-content">
      <form (ngSubmit)="onSubmitGameMap()" #gameMapForm="ngForm" class="form">
        <div class="form-group">
          <label>T√≠tulo do GameMap:</label>
          <input type="text" name="title" [(ngModel)]="gameMap.title" required class="form-input"
            placeholder="Digite o nome do GameMap..." />
        </div>

        <div class="form-group" *ngIf="editGameMapId">
          <label>Informa√ß√µes:</label>
          <div class="gamemap-info">
            <div class="info-item">
              <strong>Usu√°rios:</strong> {{ gameMap.users?.length || 0 }}
            </div>
            <div class="info-item">
              <strong>Fases:</strong> {{ gameMap.phases?.length || 0 }}
            </div>
            <div class="info-item" *ngIf="gameMap.createdAt">
              <strong>Criado em:</strong> {{ formatDate(gameMap.createdAt) }}
            </div>
            <div class="info-item" *ngIf="gameMap.createdByUser">
              <strong>Criado por:</strong> {{ gameMap.createdByUser.name }}
            </div>
          </div>
        </div>

        <button type="submit" class="btn-primary" [disabled]="!gameMap.title || !gameMap.title.trim()">
          {{ editGameMapId ? 'Atualizar GameMap' : 'Salvar GameMap' }}
        </button>
        <button type="button" (click)="resetGameMapForm()" class="btn-secondary">
          Limpar
        </button>
      </form>

      <div class="gamemaps-list">
        <div *ngFor="let gm of gameMaps; let i = index" class="gamemap-card">
          <div class="gamemap-header">
            <div class="gamemap-title">
              <h4>Mapa{{ gm.title }}</h4>
              <span class="gamemap-id">ID: {{ gm.id }}</span>
            </div>
            <div class="gamemap-stats">
              <span class="stat-badge users">Usu√°rios{{ gm.users?.length || 0 }}</span>
              <span class="stat-badge phases">Fases{{ gm.phases?.length || 0 }}</span>
            </div>
          </div>

          <div class="gamemap-details">
            <div class="detail-row">
              <div class="detail-item" *ngIf="gm.createdAt">
                <span class="detail-label">Criado:</span>
                <span class="detail-value">{{ formatDate(gm.createdAt) }}</span>
              </div>
              <div class="detail-item" *ngIf="gm.createdByUser">
                <span class="detail-label">Por:</span>
                <span class="detail-value">{{ gm.createdByUser.name }}</span>
              </div>
            </div>
          </div>

          <div class="item-actions">
            <button class="btn-edit" (click)="editGameMap(i)" title="Editar GameMap">
              Editar
            </button>
            <button class="btn-delete" (click)="deleteGameMap(i)" title="Remover GameMap">
              Remover
            </button>
          </div>
        </div>

        <div *ngIf="gameMaps.length === 0" class="empty-state">
          <div class="empty-icon">Mapas</div>
          <h3>Nenhum GameMap cadastrado</h3>
          <p>Crie seu primeiro GameMap para come√ßar a organizar as fases do jogo.</p>
        </div>
      </div>
    </div>
  </div>
</div>