<div id="container">

    <app-header 
        [parentType]="'game-map'"
        [gameMapId]="gameMapId">
    </app-header>

    <div class="wrapper">
        <div class="swiper-button-prev"></div>
        <div class="swiper" #swiperContainer>
            <div class="swiper-wrapper" *ngIf="phaseUsersAvailable.length > 0">
                <div class="swiper-slide" *ngFor="let phaseUser of phaseUsersAvailable">
                    <h1 *ngIf="phaseUser.phase.nodeType == 'ACTIVITY'">Complete o desafio</h1>
                    <h1 *ngIf="phaseUser.phase.nodeType == 'DECISION'">Tome sua decisão</h1>
                    <div class="phase-card">
                        <!-- carimbo no canto superior direito quando COMPLETED -->
                        <div *ngIf="phaseUser.status === 'COMPLETED'" class="stamp-complete" aria-hidden="true">
                        COMPLETO
                        </div>
                        <div class="left">
                            <div class="left-top">
                                <h3>{{ phaseUser.phase.title }}</h3>
                                <p>{{ phaseUser.phase.description }}</p>
                                <div class="phase-data" *ngIf="phaseUser.phase.nodeType !== 'DECISION'">
                                    <div class="accuracy">
                                        <lucide-icon name="square-check" class="lucide-icon" [size]="24" color="#00D819"></lucide-icon>
                                        <span>{{ phaseUser.accuracy }}%</span>
                                    </div>
                                    <div class="reputation">
                                        <span>{{ phaseUser.reputation }}</span>
                                        <lucide-icon name="sparkles" class="lucide-icon" [size]="20" color="#000000"></lucide-icon>
                                    </div>
                                </div>
                            </div>
                            <div class="left-bottom">
                                <!-- se for DECISION e já está COMPLETED/AVAILABLE e tem outgoing, renderiza botões -->
                                <div *ngIf="phaseUser.phase.nodeType === 'DECISION'">
                                    <ng-container *ngFor="let t of outgoingMapForPhase(phaseUser.phase.id)">
                                        <button
                                        class="active"
                                        (click)="onDecisionChoice(phaseUser, t)"
                                        [disabled]="isDecisionOptionDisabled(phaseUser, t)"
                                        [ngClass]="{ 'disabled': isDecisionOptionDisabled(phaseUser, t) }"
                                        >
                                        {{ t.optionText || 'Escolher' }}
                                        </button>
                                    </ng-container>
                                </div>

                               <button
                                *ngIf="phaseUser.phase.nodeType !== 'DECISION'"
                                class="active"
                                [disabled]="phaseUser.status !== 'AVAILABLE' && phaseUser.status !== 'COMPLETED'"
                                [ngClass]="{ 'disabled': phaseUser.status !== 'AVAILABLE' && phaseUser.status !== 'COMPLETED' }"
                                (click)="openGamePhase(phaseUser)">
                                {{ phaseUser.status === 'COMPLETED' ? 'Jogar novamente' : 'Jogar' }}
                                </button>
    
                            </div>
                        </div>
    
                        <img [src]="getCharacterImageUrl(phaseUser)" 
                            [alt]="phaseUser.phase.character.name" 
                            class="character"
                        >
                    </div>
                </div>
            </div>
    
            <!-- Paginação -->
            <div class="swiper-pagination"></div>
        </div>
        <div class="swiper-button-next"></div>
    </div>
    <div class="progress-bar">
        <div class="progress" [style.width.%]="calculateProgress()">
            <div class="user-avatar">
                <img 
                    [src]="getUserAvatarUrl()"
                    [alt]="userData?.name || 'Avatar do usuário'"
                >
                <span class="percentage">{{ calculateProgress() }}%</span>
            </div>
        </div>
    </div>
</div>